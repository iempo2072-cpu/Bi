-- WindUI ส่วนเดิม --
local WindUI
do
    local ok, result = pcall(function()
        return require("./src/Init")
    end)
    if ok then
        WindUI = result
    else
        WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/refs/heads/main/dist/main.lua"))()
    end
end

local Window = WindUI:CreateWindow({
    Title = "HAN XHUB",
    Author = "HAN XHUB",
    Folder = "ftgshub",
    Icon = "computer",
    NewElements = true,
    HideSearchBar = false,
    OpenButton = {
        Title = "HAN XHUB",
        CornerRadius = UDim.new(1,0),
        StrokeThickness = 3,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false,
        Color = ColorSequence.new(Color3.fromHex("#30FF6A"), Color3.fromHex("#e7ff2f"))
    }
})

local CombatTab = Window:Tab({Title = "Combat", Icon = "sword"})
local ESPTab = Window:Tab({Title = "ESP", Icon = "eye"})
local CrateTab = Window:Tab({Title = "ข้ามสุ่มกล่อง", Icon = "package"})

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-------------------------------------------------
-- No Recoil สำหรับปืนทุกชนิด -------------------
-------------------------------------------------
local NoRecoilEnabled = false
local function doNoRecoil()
    while NoRecoilEnabled do
        task.wait(1)
        pcall(function()
            for _, tool in pairs(LocalPlayer.Backpack:GetChildren()) do
                if tool:IsA("Tool") and (tool:FindFirstChild("Recoil") or tool:GetAttribute("Recoil")) then
                    if tool:FindFirstChild("Recoil") then tool.Recoil.Value = 0 end
                    if tool:GetAttribute("Recoil") then tool:SetAttribute("Recoil", 0) end
                end
            end
            for _, tool in pairs(LocalPlayer.Character:GetChildren()) do
                if tool:IsA("Tool") and (tool:FindFirstChild("Recoil") or tool:GetAttribute("Recoil")) then
                    if tool:FindFirstChild("Recoil") then tool.Recoil.Value = 0 end
                    if tool:GetAttribute("Recoil") then tool:SetAttribute("Recoil", 0) end
                end
            end
        end)
    end
end

CombatTab:Toggle({
    Title = "No Recoil (กันกล้องดีด)",
    Default = false,
    Callback = function(v)
        NoRecoilEnabled = v
        if v then
            spawn(doNoRecoil)
        end
    end
})

-------------------------------------------------
-- Silent Aim + Velocity & FOV คม+จริง ---------
-------------------------------------------------
local SilentAimEnabled = false
local BASE_PREDICTION = 0.14
local FOVCircle = Drawing.new("Circle")
FOVCircle.Radius = 120
FOVCircle.Thickness = 2
FOVCircle.Filled = false
FOVCircle.Color = Color3.fromRGB(255,255,0)
FOVCircle.Visible = false
local showFov = false

local TracerLine = Drawing.new("Line")
TracerLine.Color = Color3.fromRGB(0,255,255)
TracerLine.Thickness = 2
TracerLine.Visible = false

CombatTab:Toggle({
    Title = "Enable Silent Aim",
    Default = false,
    Callback = function(v)
        SilentAimEnabled = v
        TracerLine.Visible = v and TracerLine.Visible
    end
})

CombatTab:Toggle({
    Title = "Show FOV Circle",
    Default = false,
    Callback = function(v)
        showFov = v
        FOVCircle.Visible = v
    end
})

CombatTab:Slider({
    Title = "FOV Radius",
    Step = 1,
    Value = {Min = 50, Max = 500, Default = FOVCircle.Radius},
    Callback = function(v)
        FOVCircle.Radius = tonumber(v)
    end
})

-- ------ Velocity Calculations -------------
local velocity = Vector3.new(0,0,0)
local lastTargetId = nil
local lastHeadPos = nil
local lastHeadTime = nil

local function UpdateTargetVelocity(target)
    -- จับเวลาและคำนวณ velocity
    if not (target and target.Character and target.Character:FindFirstChild("Head")) then return Vector3.new(0,0,0) end
    local head = target.Character.Head
    local now = tick()
    if lastTargetId ~= target.UserId then
        lastHeadPos = head.Position
        lastHeadTime = now
        lastTargetId = target.UserId
        return Vector3.new(0,0,0)
    else
        local dt = now - (lastHeadTime or now)
        lastHeadTime = now
        local vel = Vector3.new(0,0,0)
        if dt > 0 and lastHeadPos then
            vel = (head.Position - lastHeadPos) / dt
        end
        lastHeadPos = head.Position
        velocity = vel
        return vel
    end
end

local function PredictPositionUsingVelocity(head, predictionTime, vel)
    return head.Position + (vel * predictionTime)
end

local function GetClosestTargetFOV()
    -- หาคนที่ใกล้ FOV ตรงกลางจอสุด
    local closest
    local shortest = math.huge
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Head") then
            local head = plr.Character.Head
            local screenPos, onScreen = Camera:WorldToViewportPoint(head.Position)
            local dist = (Vector2.new(screenPos.X,screenPos.Y)-center).Magnitude
            if onScreen and dist < FOVCircle.Radius and dist < shortest then
                shortest = dist
                closest = plr
            end
        end
    end
    return closest
end

local send = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Send")
local oldFire
oldFire = hookfunction(send.FireServer,function(self,...)
    local args = {...}
    if SilentAimEnabled then
        local target = GetClosestTargetFOV()
        if target and target.Character then
            local head = target.Character:FindFirstChild("Head")
            -- อัปเดต velocity ตรงจุดยิง
            if head then
                local vel = UpdateTargetVelocity(target)
                local aimPos = PredictPositionUsingVelocity(head, BASE_PREDICTION, vel)
                args[4] = CFrame.new(math.huge,math.huge,math.huge,0,0,0,0,0,0,0,0,0)
                args[5] = {[1]={[1]={["Instance"]=head,["Position"]=aimPos}}}
                local myHead = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")
                if myHead then
                    -- Optional Bullet Debug
                    local dist = (aimPos-myHead.Position).Magnitude
                    local bullet = Instance.new("Part")
                    bullet.Anchored = true
                    bullet.CanCollide = false
                    bullet.Material = Enum.Material.Neon
                    bullet.Size = Vector3.new(0.1,0.1,dist)
                    bullet.CFrame = CFrame.new(myHead.Position,aimPos)*CFrame.new(0,0,-dist/2)
                    bullet.Color = Color3.fromRGB(50,255,150)
                    bullet.Parent = workspace
                    Debris:AddItem(bullet,3)
                end
            end
        end
    end
    return oldFire(self,unpack(args))
end)

RunService.RenderStepped:Connect(function()
    FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2,Camera.ViewportSize.Y/2)
    if SilentAimEnabled then
        local myHead = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")
        local target = GetClosestTargetFOV()
        if target and target.Character and target.Character:FindFirstChild("Head") then
            local targetHead = target.Character.Head
            local vel = UpdateTargetVelocity(target)
            local aimPos = PredictPositionUsingVelocity(targetHead, BASE_PREDICTION, vel)
            local my2D = Vector2.new(Camera:WorldToViewportPoint(myHead.Position).X,Camera:WorldToViewportPoint(myHead.Position).Y)
            local t2D = Vector2.new(Camera:WorldToViewportPoint(aimPos).X, Camera:WorldToViewportPoint(aimPos).Y)
            local distFromCenter = (t2D - Vector2.new(Camera.ViewportSize.X/2,Camera.ViewportSize.Y/2)).Magnitude
            if not showFov or distFromCenter<=FOVCircle.Radius then
                TracerLine.From = my2D
                TracerLine.To = t2D
                TracerLine.Visible = true
            else
                TracerLine.Visible = false
            end
        else
            TracerLine.Visible = false
        end
    else
        TracerLine.Visible = false
    end
end)

-------------------------------------------------
-- ข้ามการสุ่มกล่อง/รับไอเทมที่ต้องการ ---------
-------------------------------------------------
local wantedItem = "LegendaryRifle" -- ชื่อไอเทมที่ต้องการได้
local boxType = "rifle"

CrateTab:TextBox({
    Title = "ชื่อไอเทม (ตรงกับระบบเกม)",
    Placeholder = "เช่น LegendaryRifle",
    Callback = function(val)
        wantedItem = val
    end
})

CrateTab:Dropdown({
    Title = "ประเภทกล่อง",
    Options = {"pistol", "rifle", "sniper"},
    Default = "rifle",
    Callback = function(val)
        boxType = val
    end
})

CrateTab:Button({
    Title = "ข้ามสุ่ม! รับไอเทมนี้ทันที",
    Callback = function()
        local RemoteBox = ReplicatedStorage:FindFirstChild("Remotes") and ReplicatedStorage.Remotes:FindFirstChild("OpenBox")
        if RemoteBox then
            RemoteBox:FireServer("open", {
                ["BoxType"] = boxType,
                ["ChosenItem"] = wantedItem
            })
        else
            warn("ไม่พบ Remote OpenBox ในเกมนี้!")
        end
    end
})

-------------------------------------------------
-- ESP ระบบบ็อกซ์/ชื่อ --------------------------
-------------------------------------------------
local boxESPEnabled = false
local nameESPEnabled = false
local espPlayers = {}

ESPTab:Toggle({
    Title = "Box ESP",
    Default = false,
    Callback = function(state)
        boxESPEnabled = state
    end
})

ESPTab:Toggle({
    Title = "Name ESP",
    Default = false,
    Callback = function(state)
        nameESPEnabled = state
    end
})

local function createESP(player)
    local lines = {
        top = Drawing.new("Line"),
        bottom = Drawing.new("Line"),
        left = Drawing.new("Line"),
        right = Drawing.new("Line"),
    }
    local nameText = Drawing.new("Text")
    nameText.Size = 16
    nameText.Center = true
    nameText.Outline = true
    nameText.Color = Color3.fromRGB(255, 0, 0)
    nameText.Visible = false
    for _, line in pairs(lines) do
        line.Color = Color3.new(1, 1, 1)
        line.Thickness = 1
        line.Visible = false
    end
    local drawings = {lines.top, lines.bottom, lines.left, lines.right, nameText}
    local conn = RunService.RenderStepped:Connect(function()
        if not player.Character or not player.Character:FindFirstChild("Head") or not player.Character:FindFirstChild("HumanoidRootPart") then
            for _, line in pairs(lines) do line.Visible = false end
            nameText.Visible = false
            return
        end
        local head = player.Character.Head
        local hrp = player.Character.HumanoidRootPart
        local topWorld = head.Position + Vector3.new(0, 1, 0)
        local bottomWorld = hrp.Position - Vector3.new(0, 3.5, 0)
        local top, onTop = Camera:WorldToViewportPoint(topWorld)
        local bottom, onBottom = Camera:WorldToViewportPoint(bottomWorld)
        if onTop and onBottom and top.Z > 0 and bottom.Z > 0 then
            local height = math.abs(top.Y - bottom.Y) * 1.2
            local width = height / 1.5
            local x = top.X - width / 2
            local y = top.Y - height * 0.1
            local tl = Vector2.new(x, y)
            local tr = Vector2.new(x + width, y)
            local bl = Vector2.new(x, y + height)
            local br = Vector2.new(x + width, y + height)
            if boxESPEnabled then
                lines.top.From = tl
                lines.top.To = tr
                lines.bottom.From = bl
                lines.bottom.To = br
                lines.left.From = tl
                lines.left.To = bl
                lines.right.From = tr
                lines.right.To = br
                for _, line in pairs(lines) do line.Visible = true end
            else
                for _, line in pairs(lines) do line.Visible = false end
            end
            if nameESPEnabled then
                nameText.Text = player.Name
                nameText.Position = Vector2.new(top.X, y - 16)
                nameText.Visible = true
            else
                nameText.Visible = false
            end
        else
            for _, line in pairs(lines) do line.Visible = false end
            nameText.Visible = false
        end
    end)
    espPlayers[player] = {conn = conn, drawings = drawings}
end

local function loadESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            createESP(player)
        end
    end
    Players.PlayerAdded:Connect(function(player)
        if player ~= LocalPlayer then
            player.CharacterAdded:Connect(function()
                wait(0.1)
                createESP(player)
            end)
        end
    end)
    Players.PlayerRemoving:Connect(function(player)
        if espPlayers[player] then
            espPlayers[player].conn:Disconnect()
            for _, drawing in pairs(espPlayers[player].drawings) do
                drawing:Remove()
            end
            espPlayers[player] = nil
        end
    end)
end

loadESP()
