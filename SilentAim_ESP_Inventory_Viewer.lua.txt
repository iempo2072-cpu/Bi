-- เพิ่ม GUI เปิด/ปิด สำหรับระบบ anti_stomp
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AntiStompControl"
ScreenGui.Parent = game.Players.LocalPlayer:FindFirstChildOfClass("PlayerGui")

local ToggleButton = Instance.new("TextButton")
ToggleButton.Parent = ScreenGui
ToggleButton.Size = UDim2.new(0,150,0,50)
ToggleButton.Position = UDim2.new(0,20,0,20)
ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 150, 40)
ToggleButton.Text = "เปิด: anti_stomp"
ToggleButton.TextColor3 = Color3.fromRGB(255,255,255)
ToggleButton.Font = Enum.Font.SourceSansBold
ToggleButton.TextSize = 24

-- สถานะเปิด/ปิด
local anti_stomp_enabled = true

ToggleButton.MouseButton1Click:Connect(function()
    anti_stomp_enabled = not anti_stomp_enabled
    ToggleButton.Text = (anti_stomp_enabled and "เปิด: anti_stomp" or "ปิด: anti_stomp")
    ToggleButton.BackgroundColor3 = (anti_stomp_enabled and Color3.fromRGB(30, 150, 40) or Color3.fromRGB(180, 30, 30))
end)

while true do 
    if not anti_stomp_enabled then
        task.wait(0.25)
        continue
    end

    local char = lp.Character
    if char and char:FindFirstChild("Humanoid") and char.PrimaryPart then 
        local hum : Humanoid = char.Humanoid
        local primaryPart : BasePart  = char.PrimaryPart
        if hum:GetAttribute('HasBeenDowned') then 
            if not hum:GetAttribute('IsDead') then 
                if hum.Health > 0 and primaryPart then
                    local deathscreen = playergui.DeathScreen.DeathScreenHolder
                    if not deathscreen.Visible then 
                        local Radius = 13

                        local targetY = primaryPart.Position.Y - Radius
                        local currentY = primaryPart.Position.Y
                        local deltaY = targetY - currentY

                        local Gan = math.random(-5, 15)
                        primaryPart.Anchored = false 
                        primaryPart.CanCollide = false
                        primaryPart.CFrame = primaryPart.CFrame * CFrame.new(Gan, deltaY, Gan)
                        primaryPart.Velocity = Vector3.new(primaryPart.Velocity.X,-10,primaryPart.Velocity.Z)
                        for i,v in next,char:GetChildren() do 
                            if v:IsA("BasePart") then 
                                v.CanCollide = false 
                                v.Anchored = false 
                                v.CFrame = v.CFrame * CFrame.new(0, deltaY, 0)
                                v.Velocity = Vector3.new(v.Velocity.X,-10,v.Velocity.Z)
                            end
                        end
                        -- รีโมทรัวๆ
                        for i = 1,5 do
                            game.ReplicatedStorage.RemoteEvent:FireServer("ลง", math.random())
                        end
                        EverDown = true
                    end
                else 
                    EverDown = false 
                end
            else 
                EverDown = false 
            end
        else 
            if EverDown then 
                local ganys = 15
                local targetY = primaryPart.Position.Y - ganys
                local currentY = primaryPart.Position.Y
                local deltaY = targetY - currentY
                primaryPart.CFrame = primaryPart.CFrame * CFrame.new(0, deltaY, 0)
                if not lp:GetAttribute('IsInCombat') then 
                    EverDown = false
                    library.reset("player is in a downed state")
                end
                -- รีโมทรัวๆ
                for i = 1,5 do
                    game.ReplicatedStorage.RemoteEvent:FireServer("downed", math.random())
                end
            end
        end
    end
    task.wait(0.25)
end
