-- LocalScript ใน StarterGui
local Players = game:GetService("Players")
local workspace = game:GetService("Workspace")

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BlockSpinDoorMagnetGui"
screenGui.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")

local playerBox = Instance.new("TextBox")
playerBox.Position = UDim2.new(0.39, 0, 0.33, 0)
playerBox.Size = UDim2.new(0, 200, 0, 38)
playerBox.PlaceholderText = "ชื่อเป้าหมาย"
playerBox.Text = ""
playerBox.Parent = screenGui

local toggleBtn = Instance.new("TextButton")
toggleBtn.Position = UDim2.new(0.39, 0, 0.39, 0)
toggleBtn.Size = UDim2.new(0, 200, 0, 38)
toggleBtn.Text = "ดึงประตูปั่นคน!"
toggleBtn.Parent = screenGui

local infoLabel = Instance.new("TextLabel")
infoLabel.Position = UDim2.new(0.39, 0, 0.45, 0)
infoLabel.Size = UDim2.new(0, 200, 0, 28)
infoLabel.Text = ""
infoLabel.Parent = screenGui

local spinning = false

-- ถ้าในแมพ มี Model ประตูเยอะ (เช่น ตั้งชื่อว่า "Door") จะค้นหาเฉพาะ Parts หรือ Models ที่ชื่อ Door
function getDoorsFromMap()
    local doors = {}
    for _,v in pairs(workspace:GetChildren()) do
        if v.Name:lower():find("door") then -- ชื่อประกอบด้วย "door"
            if v:IsA("BasePart") or v:IsA("Model") then
                table.insert(doors, v)
            end
        end
    end
    return doors
end

toggleBtn.MouseButton1Click:Connect(function()
    local targetName = playerBox.Text
    local targetPlayer = Players:FindFirstChild(targetName)
    if not targetPlayer or not targetPlayer.Character or not targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
        infoLabel.Text = "ไม่พบเป้าหมาย!"
        wait(1)
        infoLabel.Text = ""
        return
    end

    spinning = not spinning
    toggleBtn.Text = spinning and "หยุดปั่น" or "ดึงประตูปั่นคน!"

    if spinning then
        infoLabel.Text = "กำลังดึงประตูปั่น " .. targetName .. "!"
        spawn(function()
            while spinning do
                local root = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
                if root then
                    local doors = getDoorsFromMap()
                    for i,door in pairs(doors) do
                        -- ถ้าเป็น Model เลือก PrimaryPart หรือส่วนที่อยากย้าย
                        local mainPart = door
                        if door:IsA("Model") then
                            mainPart = door.PrimaryPart or door:FindFirstChildWhichIsA("BasePart")
                        end
                        if mainPart then
                            -- ย้ายมาใกล้ๆรอบตัว คนเป้าหมาย
                            local angle = math.rad(i * 30) -- กระจายรอบวง
                            mainPart.Position = root.Position + Vector3.new(math.cos(angle)*5, 3, math.sin(angle)*5)
                            -- ให้ประตูไม่ Anchored เพื่อฟิสิกส์ทำงาน
                            mainPart.Anchored = false
                            mainPart.CanCollide = true

                            -- ผลักแรงเข้าเป้าหมาย + หมุนแรง
                            local bv = Instance.new("BodyVelocity", mainPart)
                            bv.MaxForce = Vector3.new(1e5,1e5,1e5)
                            bv.Velocity = (root.Position - mainPart.Position).unit * 70 + Vector3.new(0, 20, 0)
                            local ba = Instance.new("BodyAngularVelocity", mainPart)
                            ba.AngularVelocity = Vector3.new(0, 50, 0)
                            ba.MaxTorque = Vector3.new(1e5,1e5,1e5)
                        end
                    end
                end
                wait(1)
            end
            infoLabel.Text = ""
        end)
    else
        infoLabel.Text = ""
    end
end)
